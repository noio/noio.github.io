<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="google-site-verification" content="GczuurekKRrnQbnvMKZe8V37yWH66ZewOF86uJfN27I" />
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="application/rss+xml" title="noio" href="http://www.noio.nl/feed.xml">
    <link rel="stylesheet" href="https://use.typekit.net/atq8emw.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/b667dff85b9fc0286902b8e6adff8b90.png?size=32" />
    <style>
        body {
            max-width: 800px;
            margin: auto;
            font-family: 'effra', sans-serif;
            font-weight: 400;
            font-size: 20px;
            line-height: 32px;
            padding-bottom: 100px;
        }

        li {
            margin: 8px 0;
        }

        img {
            max-width: 100%;
        }

        .logo>a{
            border-bottom: 3px solid blue;
        }

        .tag {
            font-weight: 300;
        }

        blockquote {
            border-left: 4px solid #666;
            margin-left: 0;
            padding-left: 1em;
            color: #666;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0px;
            width: 100%;
            overflow: auto;
            break-inside: auto;
            text-align: left;
            padding: 0;
            word-break: initial;
        }

        table tr {
            border-top: 1px solid #dfe2e5;
            margin: 0;
            padding: 0;
        }

        table tr:nth-child(2n),
        thead {
            background-color: #f8f8f8;
        }

        table tr th {
            font-weight: bold;
            border: 1px solid #dfe2e5;
            border-bottom: 0;
            text-align: left;
            margin: 0;
            padding: 6px 13px;
        }

        table tr td {
            border: 1px solid #dfe2e5;
            text-align: left;
            margin: 0;
            padding: 6px 13px;
        }

        table tr th:first-child,
        table tr td:first-child {
            margin-top: 0;
        }

        table tr th:last-child,
        table tr td:last-child {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <h1 class="logo"><a href="/"><img alt="noio" src="/assets/_site/noio.png"></a></h1>
    <br/>
    <div>
        <div class="post">
  <h1>Stacking Boxes in Unity</h1>
  <p>While working on a prototype recently, I was mocking up a structure made of a tower of boxes in Unity's physics engine. I could not get them to stack in a stable way, which surprised me because it was 'only' 15 boxes high. I realized that I don't know how many boxes you can reasonable expect to stack in Unity's implementation of Physx. I did some searches, but &quot;Unity Box Stacking Stability&quot; did not turn up any numbers, except advice about different parameters to tweak. After an hour of tuning different physics settings back and forth, I decided to investigate a bit more thoroughly and share my findings.</p>
<p>The definition of &quot;sucessfully stacking&quot; that I used is whether a stack of boxes goes to <em>sleep</em>, or whether one of the boxes touches the ground after falling. When either of those things happens, I recorded how many frames that took.</p>
<p><img src="/assets/2018-11-20-box-stacking/animation-basic.gif" alt="animation-basic"></p>
<p>So, turns out that with Unity's default settings, you can stack up to about 12 unit-sized boxes (the thing you get when you do <em>GameObject &gt; 3D Object &gt; Cube</em>). However, with 10-12 boxes, they 'wobble' almost indefinitely, and it takes thousands of frames for them to go asleep, if they do so at all. I aborted the simulation at 1000 frames.</p>
<p><img src="/assets/2018-11-20-box-stacking/unity-out-of-the-box.png" alt="chart"></p>
<p>Okay, so 20 boxes is definitely unstable. What can one do to make them stack nicely?</p>
<h2>Solver Iterations</h2>
<p>The main factor in stability is the number of solver iterations steps that the physics engine applies per simulation frame. Good numbers for solver iterations are influenced by other factors. What counts is the number of solver steps relative to the amount of motion in a frame.</p>
<p>For example: with a longer <code>fixedDeltaTime</code>, objects with the same speed cover more distance in a single frame, so there are fewer solver iterations per distance of movement.</p>
<p>With a higher <em>gravity</em>, objects will fall faster in the same timespan, which also means fewer solver iterations per distance of movement.</p>
<p>From <a href="https://docs.unity3d.com/Manual/class-PhysicsManager.html">Unity Docs: Physics Manager</a></p>
<blockquote>
<p><strong>Note</strong>: If you increase the gravity, you might need to also increase the <strong>Default Solver Iterations</strong> value to maintain stable contacts.</p>
</blockquote>
<p>By decreasing the fixed timestep or the gravity, a stack of 20 boxes can be made stable:</p>
<p><img src="/assets/2018-11-20-box-stacking/gravity.png" alt="gravity"></p>
<p><img src="/assets/2018-11-20-box-stacking/timestep.png" alt="timestep"></p>
<p>However, it is likely that in a game the values for the fixed timestep and gravity are pinned by other considerations like gameplay. And because they influence stability in much the same way as the number of solver iterations does, I am just going to vary the number of iterations.</p>
<p>So, if you want to stack more boxes, increasing the solver iterations will eventually make it stable. The chart below shows how many you would need. Such high solver iterations counts are probably not feasible in a real game, but it gives an idea of what it costs to 'brute force' the stability. I ran each configuration multiple times, so the percentage below shows how many of those stacks eventually became stable and went to sleep.</p>
<p><img src="/assets/2018-11-20-box-stacking/boxes-versus-solver-iterations.png" alt="boxes-versus-solver-iterations"></p>
<p>Of course, there are other, more thoughtful, ways to increase stability, depending on the gameplay you want to achieve. For example, you might not need all of the boxes to be simulated all the time, you could hold them in place with joints, etc. The goal of this post was simply to establish whether or not it is reasonable to expect a stack of boxes to stay in place without doing any of those things.</p>
<p>I used <strong>Unity 2018.2</strong>, which uses <strong>PhysX 3.3.3</strong> under the hood.</p>
<p>Get the code at https://github.com/noio/box-stacking-stability to to run your own experiment.</p>
<h2>Next post</h2>
<p>I did some more experiments with boxes with compound colliders and a different method of stacking them in <a href="/2018/11/stacking-more-boxes/">the next post</a></p>

</div>
    </div>
</body>

</html>